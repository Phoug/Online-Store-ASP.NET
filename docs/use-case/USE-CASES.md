# Online Store – Анализ вариантов использования

## Акторы

### **Гость (Неавторизованный пользователь)**
Может просматривать каталог товаров, использовать поиск и фильтрацию, просматривать карточки товаров.

### **Зарегистрированный пользователь (Покупатель)**
Авторизованный пользователь с ролью "Customer". Может добавлять товары в корзину, оформлять заказы, просматривать историю заказов, добавлять товары в избранное, оставлять отзывы.

### **Администратор**
Пользователь с ролью "Admin". Может управлять товарами, заказами и пользователями.

### **Система / Email-сервис**
Внешняя система для отправки уведомлений по электронной почте (регистрация, подтверждение заказа, изменение статуса).

---

## Use Case сценарии

### **UC1: Регистрация пользователя**

**Актор:** Гость  
**Предусловие:** Пользователь не авторизован и находится на странице регистрации.

**Основной поток событий:**
1. Пользователь открывает страницу регистрации.
2. Форма содержит поля: Имя, Email, Пароль, Подтверждение пароля, кнопка «Зарегистрироваться».
3. Пользователь заполняет форму и нажимает «Зарегистрироваться».
4. Система проверяет:
   - заполненность обязательных полей;
   - корректность формата Email;
   - минимальную длину пароля;
   - совпадение пароля и подтверждения;
   - уникальность Email.
5. При успешной валидации создаётся запись User (Role = Customer, пароль в виде хеша, IsBlocked = false).
6. Генерируется JWT‑токен и возвращается вместе с данными пользователя.
7. Токен сохраняется на клиенте, пользователь считается авторизованным.

**Альтернативные потоки:**
- Email уже используется → сообщение «Этот email уже зарегистрирован».
- Пароли не совпадают → сообщение под полем подтверждения.
- Ошибки формата или пустые поля → красные подсказки под соответствующими полями.

**Постусловие:** В системе создан новый пользователь, который сразу авторизован.

---

### **UC2: Вход в систему**

**Актор:** Гость  
**Предусловие:** Пользователь не авторизован и находится на странице входа.

**Основной поток событий:**
1. Пользователь открывает страницу входа.
2. Форма содержит поля: Email, Пароль, кнопка «Войти».
3. Пользователь вводит данные и нажимает «Войти».
4. Система ищет User по Email и сверяет пароль с PasswordHash.
5. Система проверяет, что пользователь не заблокирован.
6. При успехе генерируется JWT‑токен и возвращается клиенту.
7. Токен сохраняется на клиенте, в интерфейсе отображается имя пользователя, подключается его корзина.

**Альтернативные потоки:**
- Неверный Email или пароль → сообщение «Неверные учётные данные».
- Пользователь заблокирован → сообщение «Аккаунт заблокирован».

**Постусловие:** Пользователь авторизован, его корзина и профиль доступны.

---

### **UC3: Добавление товара в корзину**

**Актор:** Зарегистрированный пользователь  
**Предусловие:** Пользователь авторизован и находится на странице товара.

**Основной поток событий:**
1. Пользователь открывает карточку товара (Product).
2. Пользователь указывает количество (по умолчанию 1) и нажимает «Добавить в корзину».
3. Система проверяет:
   - что товар активен (IsActive = true);
   - что на складе достаточно товара (Stock ≥ количество).
4. Система находит корзину пользователя (Cart) или создаёт новую.
5. Система ищет CartItem с данным ProductId:
   - если запись есть — увеличивает Quantity;
   - если нет — создаёт новый CartItem с текущей ценой товара.
6. Система пересчитывает Cart.TotalAmount и сохраняет изменения.
7. Интерфейс обновляет счётчик корзины и показывает уведомление «Товар добавлен в корзину».

**Альтернативные потоки:**
- Недостаточно товара на складе → сообщение «Недостаточно товара на складе».
- Товар снят с продажи → сообщение «Товар недоступен».

**Постусловие:** В корзине пользователя есть позиция CartItem для выбранного товара, сумма корзины пересчитана.

---

### **UC4: Оформление заказа**

**Актор:** Зарегистрированный пользователь  
**Предусловие:** Пользователь авторизован, в корзине есть хотя бы один CartItem.

**Основной поток событий:**
1. Пользователь открывает корзину и нажимает «Оформить заказ».
2. Система показывает форму с полями: адрес доставки, телефон, комментарий.
3. Пользователь заполняет форму и подтверждает заказ.
4. Система проверяет корректность данных и доступность товаров (Stock ≥ Quantity для каждого CartItem).
5. В одной транзакции создаётся:
   - Order со статусом «New» и общей суммой;
   - набор OrderItem по содержимому корзины;
   - запись Delivery с базовой информацией о доставке.
6. Для каждого товара уменьшается Stock, корзина очищается.
7. Система отправляет пользователю письмо-подтверждение и возвращает данные заказа.
8. Пользователь видит страницу с номером и статусом заказа.

**Альтернативные потоки:**
- Корзина пуста при открытии оформления → сообщение «Корзина пуста».
- Какой‑то товар закончился → сообщение с указанием товара, заказ не создаётся.
- Ошибка валидации формы доставки → подсветка полей с ошибками.

**Постусловие:** В системе создан заказ (Order) со статусом «New», корзина очищена.

---

### **UC5: Управление товарами (Администратор)**

**Актор:** Администратор  
**Предусловие:** Администратор авторизован и открыл страницу «Управление товарами».

**Основной поток событий (добавление товара):**
1. Администратор нажимает «Добавить товар».
2. Форма содержит поля: Название, Описание, Цена, Категория, Остаток на складе, опционально бренд и скидочная цена, загрузка изображений.
3. Администратор заполняет форму и нажимает «Сохранить».
4. Система валидирует данные (обязательные поля, неотрицательная цена и остаток).
5. Изображения загружаются в файловое хранилище, их URL сохраняются.
6. В БД создаётся новая запись Product (IsActive = true).
7. Список товаров обновляется, показывается уведомление «Товар добавлен».

**Основной поток событий (редактирование товара):**
1. Администратор выбирает товар и нажимает «Редактировать».
2. Система подставляет текущие данные в форму.
3. Администратор вносит изменения и сохраняет.
4. Система валидирует данные и обновляет запись Product.
5. При замене изображений старые файлы при необходимости удаляются.
6. Отображается уведомление «Товар обновлён».

**Основной поток событий (удаление или деактивация товара):**
1. Администратор нажимает «Удалить» или «Снять с продажи».
2. Система проверяет, есть ли товар в активных заказах (со статусами New, Processing, Shipped).
3. Если товар участвует в активных заказах, система запрещает физическое удаление и предлагает деактивацию.
4. При деактивации IsActive устанавливается в false, товар скрывается из каталога.
5. Если товар не используется в активных заказах и выбрано удаление, система удаляет Product и
